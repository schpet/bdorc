FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    curl \
    git \
    ca-certificates \
    ripgrep \
    unzip \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user (required for claude code --dangerously-skip-permissions)
RUN useradd -m -s /bin/bash agent && \
    echo "agent ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install Go 1.24 (required for beads)
ARG TARGETARCH
RUN case "${TARGETARCH}" in \
        "amd64") GOARCH="amd64" ;; \
        "arm64") GOARCH="arm64" ;; \
        *) echo "Unsupported architecture: ${TARGETARCH}" && exit 1 ;; \
    esac && \
    curl -fsSL -o /tmp/go.tar.gz "https://go.dev/dl/go1.24.0.linux-${GOARCH}.tar.gz" && \
    tar -C /usr/local -xzf /tmp/go.tar.gz && \
    rm /tmp/go.tar.gz
ENV PATH="/usr/local/go/bin:${PATH}"

# Install jj to /usr/local/bin (system-wide)
RUN case "${TARGETARCH}" in \
        "amd64") JJARCH="x86_64" ;; \
        "arm64") JJARCH="aarch64" ;; \
        *) echo "Unsupported architecture: ${TARGETARCH}" && exit 1 ;; \
    esac && \
    curl -fsSL -o /tmp/jj.tar.gz \
        "https://github.com/jj-vcs/jj/releases/download/v0.36.0/jj-v0.36.0-${JJARCH}-unknown-linux-musl.tar.gz" && \
    tar -xzf /tmp/jj.tar.gz -C /usr/local/bin && \
    rm /tmp/jj.tar.gz

# Switch to non-root user for user-local installs
USER agent
WORKDIR /home/agent

# Install deno for agent user
RUN curl -fsSL https://deno.land/install.sh | sh
ENV DENO_INSTALL="/home/agent/.deno"
ENV PATH="${DENO_INSTALL}/bin:${PATH}"

# Create pre-configured Claude settings to skip onboarding
RUN mkdir -p /home/agent/.claude && \
    echo '{\n\
  "numStartups": 1,\n\
  "installMethod": "container",\n\
  "autoUpdates": false,\n\
  "theme": "dark",\n\
  "hasCompletedOnboarding": true,\n\
  "firstStartTime": "2025-12-16T00:00:00.000Z",\n\
  "lastOnboardingVersion": "2.0.71"\n\
}' > /home/agent/.claude.json && \
    echo '{\n\
  "permissions": {\n\
    "allow": [],\n\
    "deny": [],\n\
    "ask": []\n\
  }\n\
}' > /home/agent/.claude/settings.local.json

# Install claude code (native install - no Node.js required)
RUN curl -fsSL https://claude.ai/install.sh | bash
ENV PATH="/home/agent/.local/bin:${PATH}"

# Install beads (bd) for agent user
RUN go install github.com/steveyegge/beads/cmd/bd@latest
ENV PATH="${PATH}:/home/agent/go/bin"

# Install ebo for agent user
RUN deno install -A -g -f -n ebo jsr:@schpet/easy-bead-oven

# Set default jj identity (can be overridden via JJ_USER and JJ_EMAIL env vars)
ENV JJ_USER="Agent"
ENV JJ_EMAIL="agent@local"

# Symlink default git ignore path to mounted location
# The justfile sync-git-ignore copies the host's global gitignore to /claude/gitignore
RUN mkdir -p /home/agent/.config/git && \
    ln -s /claude/gitignore /home/agent/.config/git/ignore

WORKDIR /workspace
